<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Cart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --bg: #f5f7fb;
      --panel: #ffffff;
      --border: #e5e7eb;
      --muted: #6b7280;
      --accent: #2563eb;
      --text: #0f172a;
    }
    body {
      background: var(--bg);
      color: var(--text);
    }
    .shell {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.08);
      padding: 18px;
    }
    .table-cart thead th {
      border: none;
      background: #f1f5f9;
      color: #475569;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.3px;
      padding: 12px 10px;
    }
    .table-cart tbody td {
      border-top: 1px solid var(--border);
      vertical-align: middle;
      padding: 14px 10px;
    }
    .table-cart tbody tr:hover td { background: #f8fafc; }
    .summary {
      min-width: 240px;
      border-left: 1px solid var(--border);
      padding-left: 16px;
    }
    .empty-state {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
      max-width: 420px;
    }
    .btn-soft {
      border: 1px solid var(--border);
      background: #f8fafb;
      color: var(--text);
      border-radius: 10px;
      padding: 8px 14px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <%- include('navbar') %>

  <% const errs = (typeof errors !== 'undefined' && Array.isArray(errors)) ? errors : []; %>
  <% const msgs = (typeof messages !== 'undefined' && Array.isArray(messages)) ? messages : []; %>
  <% const items = (typeof cart !== 'undefined' && Array.isArray(cart)) ? cart : []; %>
  <% const searchVal = (typeof search !== 'undefined' && search != null) ? search : ''; %>
  <%
    const round2 = num => Math.round(Number(num || 0) * 100) / 100;
    const fallbackSubtotal = items.reduce(
      (sum, i) => round2(sum + round2(Number(i.price || 0) * Number(i.quantity || 1))),
      0
    );
    const displaySubtotal = typeof subtotal !== 'undefined' ? round2(subtotal) : fallbackSubtotal;
    const displayGst = typeof gst !== 'undefined' ? round2(gst) : round2(displaySubtotal * 0.09);
    const preDelivery = round2(displaySubtotal + displayGst);
    const displayDelivery =
      typeof deliveryFee !== 'undefined' ? round2(deliveryFee) : preDelivery >= 50 ? 0 : 5;
    const displayTotal = round2(preDelivery + displayDelivery);
  %>

  <div class="container mt-4">
    <% if (errs.length) { %>
      <div class="alert alert-danger"><%= errs.join(', ') %></div>
    <% } %>
    <% if (msgs.length) { %>
      <div class="alert alert-success"><%= msgs.join(', ') %></div>
    <% } %>

    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <h2 class="mb-0">Shopping Cart</h2>
      <form class="d-flex" method="GET" action="/cart">
        <input type="text" name="search" class="form-control form-control-sm me-2" placeholder="Search cart items" value="<%= searchVal %>">
        <button class="btn btn-soft btn-sm" type="submit">Search</button>
      </form>
    </div>
    <% if (items.length) { %>
      <div class="shell mb-3">
        <div class="table-responsive">
          <table class="table table-cart align-middle text-center mb-0">
            <thead>
              <tr>
                <th>Image</th>
                <th>Product</th>
                <th>Quantity</th>
                <th>Subtotal</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% items.forEach(item => { %>
                <tr>
                  <td><img src="<%= item.image %>" width="70" alt="<%= item.name %>" style="border-radius:10px;border:1px solid var(--border);background:#f8fafc;"></td>
                  <td><%= item.name %></td>
                  <td>
                    <form action="/cart/update/<%= item.productId %>" method="post" class="d-flex justify-content-center gap-2">
                      <input type="number" name="quantity" value="<%= item.quantity %>" min="1" class="form-control form-control-sm text-center" style="width:90px;">
                      <button type="submit" class="btn btn-sm btn-outline-secondary">Update</button>
                    </form>
                  </td>
                  <td>$<%= (item.price * item.quantity).toFixed(2) %></td>
                  <td>
                    <form action="/cart/remove/<%= item.productId %>" method="post">
                      <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-start flex-wrap gap-3 shell">
        <div class="d-flex flex-column gap-2">
          <div class="d-flex justify-content-between" style="min-width: 220px;">
            <span>Subtotal</span>
            <span>$<%= displaySubtotal.toFixed(2) %></span>
          </div>
          <div class="d-flex justify-content-between" style="min-width: 220px;">
            <span>GST (9%)</span>
            <span>$<%= displayGst.toFixed(2) %></span>
          </div>
          <div class="d-flex justify-content-between" style="min-width: 220px;">
            <span>Delivery Fee</span>
            <span>$<%= displayDelivery.toFixed(2) %></span>
          </div>
          <hr class="my-2">
          <h4 class="mb-0">Total: $<%= displayTotal.toFixed(2) %></h4>
        </div>
        <div class="d-flex flex-column gap-2 summary">
          <a href="/payment" class="btn btn-primary w-100">Checkout</a>
          <a href="/shopping" class="btn btn-soft w-100">Back to Shopping</a>
          <form action="/cart/clear" method="post" class="w-100 d-none d-md-block">
            <button type="submit" class="btn btn-outline-danger w-100">Clear Cart</button>
          </form>
          <a href="/cart/clear" class="btn btn-outline-danger w-100 d-md-none">Clear Cart</a>
        </div>
      </div>
    <% } else { %>
      <div class="empty-state">
        <h4 class="mb-2">Your cart is empty</h4>
        <p class="text-muted mb-3">Add items from the shop to see them here.</p>
        <a href="/shopping" class="btn btn-primary">Start Shopping</a>
      </div>
    <% } %>
  </div>
</body>
</html>
