<% const favouriteHighlightFlag = typeof favouriteHighlight !== 'undefined' ? favouriteHighlight : false; %>
<% const discountPct = Number(product.discount || 0); %>
<% const hasDiscountPrice = product.discountPrice !== null && product.discountPrice !== undefined; %>
<% const hasDiscount = discountPct > 0 || hasDiscountPrice; %>
<% const effectiveDiscountPrice = hasDiscountPrice
  ? Number(product.discountPrice)
  : Number((Number(product.price || 0) * (1 - discountPct / 100)).toFixed(2)); %>
<div class="card h-100 <%= product.isFavorite ? 'border-warning' : '' %> <%= favouriteHighlightFlag ? 'favorite-highlight shadow-sm' : '' %> <%= hasDiscount ? 'discounted-card' : '' %>">
  <a href="/product/<%= product.id %>">
    <img src="<%= product.image %>" class="card-img-top" alt="<%= product.name %>" style="height: 180px; object-fit: contain; background: #f8f9fa;">
  </a>
  <div class="card-body d-flex flex-column">
    <div class="d-flex align-items-center justify-content-between">
      <h5 class="card-title mb-0">
        <a href="/product/<%= product.id %>" class="text-decoration-none"><%= product.name %></a>
      </h5>
      <% if (product.isFavorite) { %>
        <span class="badge bg-warning text-dark">&#9733; Favourite</span>
      <% } %>
    </div>
    <% const avg = Number(product.ratingAverage || 0); const cnt = Number(product.ratingCount || 0); %>
    <% const starFilled = '&#9733;'; const starEmpty = '&#9734;'; const renderStars = val => {
         const whole = Math.round(val);
         return starFilled.repeat(whole) + starEmpty.repeat(5 - whole);
       }; %>
    <div class="text-warning small mb-1">
      <span class="me-1"><%- renderStars(avg) %></span>
      <span class="text-muted"><%= avg.toFixed(1) %> stars (<%= cnt %> review<%= cnt === 1 ? '' : 's' %>)</span>
    </div>
    <div class="mb-1">
      <% if (hasDiscount) { %>
        <div class="d-flex align-items-center gap-2">
          <span class="text-muted text-decoration-line-through">$<%= Number(product.price).toFixed(2) %></span>
          <span class="discount-pill">-<%= discountPct.toFixed(0) %>%</span>
        </div>
        <div class="price-main price-new">$<%= effectiveDiscountPrice.toFixed(2) %></div>
      <% } else { %>
        <p class="card-text price-main mb-1">$<%= Number(product.price).toFixed(2) %></p>
      <% } %>
    </div>
    <% if (product.description) { %>
      <p class="card-text text-muted small mb-2"><%= product.description.length > 80 ? product.description.slice(0, 77) + '...' : product.description %></p>
    <% } %>
    <% const stockState = product.stock <= 0
      ? { cls: 'bg-danger text-white', label: 'Out of stock' }
      : (product.stock < 20
          ? { cls: 'bg-warning text-dark', label: `Low stock: ${product.stock}` }
          : { cls: 'bg-secondary text-white', label: `Stock: ${product.stock}` });
    %>
    <% if (product.category) { %>
      <p class="card-text text-muted mb-2">Category: <%= product.category %></p>
    <% } %>
    <div class="d-flex gap-2 mt-auto align-items-stretch">
      <% if (session && session.user) { %>
        <form action="/cart/add" method="POST" class="flex-fill">
          <input type="hidden" name="productId" value="<%= product.id %>">
          <div class="input-group">
            <input type="number" name="quantity" class="form-control" min="1" value="1" inputmode="numeric" <%= product.stock <= 0 ? 'disabled' : '' %>>
            <button type="submit" class="btn btn-primary" <%= product.stock <= 0 ? 'disabled' : '' %>>Add</button>
          </div>
        </form>
        <form action="/products/<%= product.id %>/favorite" method="POST" class="flex-fill">
          <input type="hidden" name="favorite" value="<%= product.isFavorite ? 0 : 1 %>">
          <button type="submit" class="btn <%= product.isFavorite ? 'btn-warning' : 'btn-outline-warning' %> w-100">
            <%= product.isFavorite ? 'Unfavourite' : 'Favourite' %>
          </button>
        </form>
      <% } else { %>
        <div class="flex-fill">
          <button type="button" class="btn btn-outline-secondary w-100" disabled>Login to add</button>
        </div>
      <% } %>
    </div>
    <div class="mt-2">
      <span class="badge <%= stockState.cls %> w-100 py-2 text-center"><%= stockState.label %></span>
    </div>
  </div>
</div>
