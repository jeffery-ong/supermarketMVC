<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <title>Inventory - Supermarket App</title>
</head>
<body>
  <%- include('navbar') %>

  <% const invErrors = (typeof errors !== 'undefined' && Array.isArray(errors)) ? errors : []; %>
  <% const invMessages = (typeof messages !== 'undefined' && Array.isArray(messages)) ? messages : []; %>

  <div class="container mt-4">
    <% if (invErrors.length) { %>
      <div class="alert alert-danger"><%= invErrors.join(', ') %></div>
    <% } %>
    <% if (invMessages.length) { %>
      <div class="alert alert-success"><%= invMessages.join(', ') %></div>
    <% } %>

    <h2>Product Inventory</h2>
    <p><a href="/addProduct" class="btn btn-primary">Add New Product</a></p>

    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Product Name</th>
          <th>Product Image</th>
          <th>Quantity</th>
          <th>Price</th>
          <th>Description</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% (Array.isArray(products) ? products : []).forEach(function(product) { %>
          <% const displayName = product.name || product.productName || 'Unnamed'; %>
          <% const rawImage = (product.image || product.productImage || '').trim(); %>
          <% const imagePath = (() => {
               if (!rawImage) return '';
               const lower = rawImage.toLowerCase();
               if (rawImage.startsWith('http') || rawImage.startsWith('/')) return rawImage;
               if (lower.startsWith('images/')) return `/${rawImage}`;
               if (!/\.(jpe?g|png|gif|webp|svg)$/.test(lower)) {
                 const base = lower.replace(/\s+/g, '-');
                 return `/images/${base}.jpg`;
               }
               return `/images/${rawImage}`;
             })(); %>
          <% const displayQuantity = (product.quantity ?? product.stock ?? product.inventory ?? 0); %>
          <tr>
            <td><a href="/product/<%= product.id %>"><%= displayName %></a></td>
            <td>
              <% if (imagePath) { %>
                <img src="<%= imagePath %>" width="60" alt="<%= displayName %>">
              <% } else { %>
                <span class="text-muted">No image</span>
              <% } %>
            </td>
            <td><%= displayQuantity %></td>
            <td>$<%= Number(product.price || 0).toFixed(2) %></td>
            <td><%= product.description || '' %></td>
            <td>
              <a href="/inventory/edit/<%= product.id %>" class="btn btn-sm btn-warning">Edit</a>
              <a href="/inventory/delete/<%= product.id %>" class="btn btn-sm btn-danger" onclick="return confirm('Delete this product?')">Delete</a>
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  </div>
</body>
</html>
